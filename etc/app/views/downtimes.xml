<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : argo-eosc 
        File    : downtimes.xml
        Created by cyril on 2019/04/16 
    -->



    <view name="downtimes">
        <argument name="tenant">ni4osnb</argument>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>
        <variable name="url" eval="property('api.downtimes')"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="downtimes">
                <set variable="group_endpoint" index="@hostname">uniq(view('api.topology.groups_endpoints',entry('tenant',$tenant))/results/endpoint,'@hostname')</set>
                <elements-ignore path="data/object/endpoints">
                    <element in="object" out="downtime">
                        <element-create>new_element('group',new_text(find($group_endpoint,../hostname/text())/@group))</element-create>
                    </element>
                </elements-ignore>
            <element-ignore/>
            </element>
        </processors>
    </view>


</views>