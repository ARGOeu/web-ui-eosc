<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">
    <!-- 
        Project : argo-eosc 
        File    : commons.xml
        Created by cyril on 2018/03/29 
    -->

    <view name="reportDetails">
        <argument name="report"/>
        <argument name="tenant"/>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('reportDetailsRaw')"/>
        </connector>

        <processors>
            <element in="root">
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>

                <element in="report" if="@tenant=$tenant and @report=$report">
                    <attribute-create out="active">true()</attribute-create>
                </element>

                <element in="report">
                    <element-ignore if="../@tenant!=$tenant or ../@report!=$report"/>
                </element>

            </element>
        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report-ar/report_details.html</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="reportTopology">

        <argument name="tenant"/>
        <argument name="report"/>

        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>
        <variable name="url" eval="concat(property('api.topology'),'/',$report)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>



        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="dashboard-filter">

        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>
        <argument name="entity">_entity_</argument>
        <argument name="status">_status_</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>


            <element in="root">
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="details">'level1'</attribute-create>
                <attribute-create out="group">$entity</attribute-create>


                <element-create>view('tenants.reports')/tenants/tenant[@id=$tenant]/report</element-create>


            </element>

            <element in="root">
                <attribute-create out="topology">
                    ../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology2
                </attribute-create>


                <element-create>
                    view('api-status-last',entry('report',$report)|entry('tenant',$tenant)|entry('topology',../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology2)|entry('entity',$entity)|entry('status',$status))
                </element-create>
                <element-create>
                    view('report-ar',entry('report',$report)|entry('tenant',$tenant)|entry('topology',../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology2)|entry('entity',$entity))
                </element-create>


            </element>

            <element in="root" out="error" if="error" attributes="@*">
                <element-ignore in="error">
                    <element/>
                </element-ignore>
            </element>


        </processors>


        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/dashboard/dashboard.html</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="dashboard">

        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>
        <argument name="scope">_scope_</argument>
        <argument name="status">_status_</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>


            <element in="root">
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="details">'level0'</attribute-create>

                <element-create>view('tenants.reports')/tenants/tenant[@id=$tenant]/report</element-create>
            </element>

            <element in="root" if="$scope='_scope_'">
                <attribute-create out="topology">
                    ../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology2
                </attribute-create>

                <element-create>view('downtimes',entry('tenant',$tenant)|entry('report',$report))</element-create>


                <element-create>
                    view('api-status-last',entry('report',$report)|entry('tenant',$tenant)|entry('topology',../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology2)|entry('status',$status))
                </element-create>

                <element-create>
                    view('report-ar',entry('report',$report)|entry('tenant',$tenant)|entry('topology',../report[@tenant=../@tenant][upper-case(@report)=upper-case(../@report)]/@topology1))
                </element-create>

            </element>


            <element in="root" out="error" if="error" attributes="@*">
                <element-ignore in="error">
                    <element/>
                </element-ignore>
            </element>


        </processors>


        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/dashboard/dashboard.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="custom">

        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>

            <element in="root">
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <element-create>view('tenants.reports')/tenants/tenant/report</element-create>

            </element>
        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/custom.html</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="reports">

        <argument name="tenant"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('api.reports')"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>

        </connector>
        <serializer type="JSONStreamSerializer"/>


        <processors>

            <element in="object" out="root">
                <element in="data">
                    <element in="object" out="result">
                    <element-ignore in="profiles">
                        <element in="object" out="profile">
                            <attribute from-element="true"/>
                            <element-ignore/>
                        </element>
                    </element-ignore>
                    </element>
                </element>

            </element>

            <element in="root">
                <attribute-create out="tenant">lower-case($tenant)</attribute-create>
                <element-create>view('tenants.reports')/tenants/tenant/report</element-create>
            </element>
        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/reports.html</parameter>
            </renderer>
        </renderers>
    </view>




    <view name="StateColor">


        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="OK">#28A745</entry>
                <entry key="WARNING">#B5892E</entry>
                <entry key="UNKNOWN">#bcbcbc</entry>
                <entry key="MISSING">#76A3D6</entry>
                <entry key="CRITICAL">#FF0000</entry>
                <entry key="DOWNTIME">grey</entry>
            </parameter>

        </connector>
    </view>


    <view name="termsofUse">
        <argument name="tenant"/>
        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root',new_attribute('tenant',$tenant))"/>
        </connector>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="template">app/html/ToU.html</parameter>
            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/ToU.html</parameter>
            </renderer>
        </renderers>

    </view>






</views>