<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : argo-eosc 
        File    : admin.xml
        Created by cyril on 2022/05/11 
    -->


 <view name="admin-console" authenticators="admin">

    <connector type="XMLConnector">
        <parameter name="content" eval="new_element('root')"/>
    </connector>

    <processors>
    <element in="root">
        <attribute-create out="view">'console'</attribute-create>
        <attribute-create out="tenant">'egi'</attribute-create>
        <attribute-create out="report">'Critical'</attribute-create>
    </element>


    <element in="root" >
        <element-create>view('argo-ui-status')</element-create>
        <element-create>new_element('reports-status',view('monitor-reports-status'))</element-create>
        <element-create>new_element('reports-ar',view('monitor-reports-ar'))</element-create>
        <element-create>view('tenants.reports')/tenants/tenant/report</element-create>
    </element>

    </processors>


        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/admin/console.html</parameter>
            </renderer>

        </renderers>

    </view>

    <view name="argo-ui-status" authenticators="admin">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('status')"></parameter>
        </connector>

        <processors>
            <element in="jmx" out="argo-ui-status">
                <elements-ignore path="/domain/group/mbean">
                    <element in="attribute" if="@name='Status'">
                        <attribute-create out="value">../value/text()</attribute-create>
                        <attribute-ignore/>
                        <text-ignore/>
                        <element-ignore/>
                    </element>
                </elements-ignore>
            </element>

            <element in="argo-ui-status">
                <element-ignore in="attribute"/>
                <element-create>new_element('view',new_attribute('status','ok')|new_attribute('count',count(../attribute[@value='SUCCESSFUL'])))</element-create>
                <element-create>new_element('view',new_attribute('status','critical')|new_attribute('count',count(../attribute[@value='FAILURE'])))</element-create>
                <element-create>new_element('view',new_attribute('status','under-build')|new_attribute('count',count(../attribute[@value='BUILDING'])))</element-create>
            </element>
        </processors>

        <pre-renderers>
            <row foreach="argo-ui-status/view">
                <column label="statut">@status</column>
                <column label="count">@count</column>
            </row>
        </pre-renderers>
    </view>

    <view name="monitor-reports-status" xmlns:date="http://exslt.org/dates-and-times" authenticators="admin">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('tenants.reports')"></parameter>
        </connector>

        <processors>
            <element in="tenants">
                <attribute-create out="date">date:date-time()</attribute-create>
                <element in="tenant">
                    <element in="report" out="reports">
                        <element-create>view('report-status',entry('tenant',../@tenant)|entry('report',../@name)|entry('topology',../@topology2))</element-create>
                        <element-ignore/>
                    </element>
                </element>
            </element>
            <element in="tenants">
                <element in="tenant">
                    <element in="reports">
                        <element in="root" out="report">
                            <attribute-create out="groups">count(../group)</attribute-create>
                            <attribute-create out="results">count(../*/status)</attribute-create>
                            <attribute-create out="firstElement">../group[1]/@name</attribute-create>
                            <element-ignore/>
                        </element>
                    </element>
                </element>
            </element>
            <element in="tenants">
                <element in="tenant">
                    <element in="reports">
                        <element in="report">
                            <element-create if="../@firstElement!=''">view('report-status',entry('tenant',../@tenant)|entry('report',../@report)|entry('topology',../@topology)|entry('entity1',../@firstElement))</element-create>
                        </element>
                    </element>
                </element>
            </element>

            <element in="tenants">
                <element in="tenant">
                    <element in="reports">
                        <element in="report">
                            <element in="root" out="report">
                                <attribute-create out="groups">count(../group)</attribute-create>
                                <attribute-create out="results">count(../*/status)</attribute-create>
                                <attribute-create out="firstElement">../group[1]/@name</attribute-create>
                                <element-ignore/>
                            </element>
                        </element>
                    </element>
                </element>
            </element>

        </processors>

        <cache type="FileCache">

            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">9</parameter>
            </trigger>

            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>tenants</entry>
                </parameter>
            </trigger>
        </cache>
        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/admin/monitor-reports.html</parameter>
            </renderer>

        </renderers>
    </view>

    <view name="monitor-reports-ar" xmlns:date="http://exslt.org/dates-and-times" authenticators="admin">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('tenants.reports')"></parameter>
        </connector>

        <processors>
            <element in="tenants">
                <attribute-create out="date">date:date-time()</attribute-create>
                <element in="tenant">
                    <element in="report" out="reports">
                        <element-create>view('report-ar-groups',entry('tenant',../@tenant)|entry('report',../@name)|entry('topology',../@topology1))</element-create>
                        <element-create>view('report-ar-groups',entry('tenant',../@tenant)|entry('report',../@name)|entry('topology',../@topology2))</element-create>
                        <element-ignore/>
                    </element>
                </element>
            </element>

            <element in="tenants">
                <element in="tenant">
                    <element in="reports">
                        <element in="root" out="report">
                            <attribute-create out="groups">count(../group)</attribute-create>
                            <attribute-create out="results">count(../*/results)</attribute-create>
                            <attribute-create out="firstElement">../group[1]/@name</attribute-create>
                            <element-create if="../group[1]/@name!='' and ../@topology!=../../@topology1">view('report-ar-group-details',entry('tenant',../@tenant)|entry('report',../@report)|entry('topology',../@topology)|entry('group',../group[1]/@name))</element-create>
                            <element-ignore/>
                        </element>
                    </element>
                </element>
            </element>

            <element in="tenants">
                <element in="tenant">
                    <element in="reports">
                        <element in="report">
                            <element in="root" out="report">
                                <attribute-create out="groups">count(../group)</attribute-create>
                                <attribute-create out="results">count(../*/results)</attribute-create>
                                <attribute-create out="firstElement">../group[1]/@name</attribute-create>
                                <element-ignore/>
                            </element>
                        </element>
                    </element>
                </element>
            </element>
        </processors>

        <cache type="FileCache">

            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>

            <trigger type="ViewNotifiedTrigger"/>

            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>tenants</entry>
                </parameter>
            </trigger>
        </cache>
        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/admin/monitor-reports.html</parameter>
            </renderer>

        </renderers>

    </view>



</views>