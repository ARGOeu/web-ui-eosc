<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : argo-eosc 
        File    : authentication.xml
        Created by cyril on 2019/04/03 
    -->

    <view name="loginAAI" authenticators="aai">

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>
            <element in="root">
                <element-create>entry('token',user('token'))</element-create>
                <element-create>view('userInfo', entry('token',user('token')))</element-create>

            </element>
        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/profile.html</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="userInfo">
        <argument name="token"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://aai-dev.egi.eu/oidc/userinfo?access_token=',$token)"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>
    </view>

    <view name="profile" authenticators="aai">
        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>
            <element in="root">
                <element-create>new_element('user',user())</element-create>
            </element>
        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/profile.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="dateUTC"  xmlns:date="http://exslt.org/dates-and-times">
        <connector type="XMLConnector">
          <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>
            <element in="root">
                <attribute-create out="sub1"> substring(date:format-date(date:date-time(),'X'),1,1)</attribute-create>
                <attribute-create out="date2">function:dateUTC()</attribute-create>
            </element>

        </processors>

    </view>


</views>