<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">
    <!-- 
        Project : argo-eosc 
        File    : ar.xml
        Created by cyril on 2018/06/13 
    -->

    <view name="report-ar-groups"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="topology"/>
        <argument name="nbmonths">4</argument>
        <argument name="filter">_filter_</argument>
        <argument name="month">1979-01</argument>


    <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>
    <variable name="start_time" eval="choose($month='1979-01',concat(str:replace(substring(date:add(date:date-time(),concat('-P',$nbmonths,'M')),0,20),' ','T'),'Z'),concat(str:replace(substring(date:add($month,concat('-P',$nbmonths,'M')),0,20),' ','T'),'Z'))"/>
    <variable name="end_time" eval="concat(str:replace(substring(date:add($start_time,concat('P',$nbmonths,'M')),0,20),' ','T'),'Z')"/>
    <variable name="url" eval="concat(property('api.report'),'/',$report,'/',$topology,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=monthly')"/>

        <variable name="month_1" eval="substring($start_time,0,8)"/>
        <variable name="month_2" eval="substring(date:add($start_time,concat('P',1,'M')),0,8)"/>
        <variable name="month_3" eval="substring(date:add($start_time,concat('P',2,'M')),0,8)"/>
        <variable name="month_4" eval="substring(date:add($start_time,concat('P',3,'M')),0,8)"/>
        <variable name="month_5" eval="substring(date:add($start_time,concat('P',4,'M')),0,8)"/>


    <connector type="HTTPConnector">
        <parameter name="url" eval="$url"/>
        <parameter name="force-redirect">true</parameter>
        <parameter name="header">
            <entry key="x-api-key" eval="$api-key"/>
            <entry key="Accept">application/xml</entry>
        </parameter>
    </connector>

        <processors>

            <element in="root">
                <attribute-create out="filter">$filter</attribute-create>
                <element-create if="$tenant='egi' and $topology='SITES'" as="first-child">view('gocdb.filter')</element-create>
                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>
                <element-ignore in="group" if="@type!=$topology"><element/></element-ignore>
                <element in="group" if="@type=$topology"><element-ignore in="group" if="@type!=$topology"/></element>
            </element>


            <element in="root">
                <attribute-create out="ApiUrl">$url</attribute-create>
                <attribute-create out="month1">choose(../group[count(results)=$nbmonths+1]/results[1]/@timestamp,../group[count(results)=$nbmonths+1]/results[1]/@timestamp,$month_1)</attribute-create>
                <attribute-create out="month2">choose(../group[count(results)=$nbmonths+1]/results[2]/@timestamp,../group[count(results)=$nbmonths+1]/results[2]/@timestamp,$month_2)</attribute-create>
                <attribute-create out="month3">choose(../group[count(results)=$nbmonths+1]/results[3]/@timestamp,../group[count(results)=$nbmonths+1]/results[3]/@timestamp,$month_3)</attribute-create>
                <attribute-create out="month4">choose(../group[count(results)=$nbmonths+1]/results[4]/@timestamp,../group[count(results)=$nbmonths+1]/results[4]/@timestamp,$month_4)</attribute-create>
                <attribute-create out="month5">choose(../group[count(results)=$nbmonths+1]/results[5]/@timestamp,../group[count(results)=$nbmonths+1]/results[5]/@timestamp,$month_5)</attribute-create>
               <attribute-create out="start_date">substring($start_time,0,11)</attribute-create>
                <attribute-create out="end_date">substring($end_time,0,11)</attribute-create>
                <attribute-create out="topology">$topology</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
            </element>


            <element in="root">

                <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
                <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>

                <element in="group">
                    <element in="results">
                        <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                    </element>
                </element>
            </element>


            <element in="root" if="$tenant='egi'">
                <set variable="listSites">view('gocdb.site')</set>

                <element in="group" if="@type='SITES' and $filter!='_filter_'">
                    <attribute-create out="filters">choose($listSites/results/SITE[@NAME=current()/../@name]/@filters,$listSites/results/SITE[@NAME=current()/../@name]/@filters,'NA')</attribute-create>
                </element>

            </element>

            <element in="root" if="$tenant='egi' and $filter!='_filter_'">
                <element-ignore in="group" if="not(contains(@filters,concat(',',$filter,',')))"/>
            </element>


        </processors>

        


        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
            <renderer type="ChartRenderer">
                            </renderer>
        </renderers>

    </view>

    <view name="report-ar-dates"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

        <argument name="report">Critical</argument>
        <argument name="tenant"></argument>
        <argument name="topology">NGI</argument>
        <argument name="entity">_entity_</argument>

        <argument name="group">NGI_FRANCE</argument>
        <argument name="granularity">daily</argument>
        <argument name="start_date"></argument>
        <argument name="end_date"></argument>

        <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>

        <variable name="start_time" eval="concat($start_date,'T00:00:00Z')"/>
        <variable name="end_time" eval="concat($end_date,'T23:59:59Z')"/>

        <variable name="url"  eval="concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=',$granularity)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>

        <processors>

            <element in="root">
                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>
                <element-ignore in="group" if="group">
                    <element-ignore in="group" if="@name!=$group and ancestor::group/@name!=$group"/>
                    <element/>
                </element-ignore>
            </element>


            <element in="root" >

                <attribute-create out="ApiUrl">$url</attribute-create>
                <attribute-create out="topology">$topology</attribute-create>
                <attribute-create out="group">$group</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="start_date">$start_date</attribute-create>
                <attribute-create out="end_date">$end_date</attribute-create>

            </element>


            <element in="root">

                <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
                <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>

                <element in="group">
                    <element in="results">
                        <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                    </element>
                </element>
            </element>

        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report_daily.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="report-ar-endpoints"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">



        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="topology"/>
        <argument name="topology2"/>
        <argument name="month"/>
        <argument name="group"/>
        <argument name="group2">_group3_</argument>
        <argument name="group3">_group3_</argument>



    <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>

    <variable name="start_time" eval="concat($month,'-01T00:00:00Z')"/>
    <variable name="end_time" eval="concat(str:replace(substring(date:add($start_time,concat('P',1,'M')),0,20),' ','T'),'Z')"/>
    <variable name="url"  eval="choose($group3='_group3_',
    concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'/',$topology2,'/',$group2,'/endpoints?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=daily'),
    concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'/',$topology2,'/',$group2,'/endpoints/',$group3,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=daily'))"/>

     <variable name="topology3" eval="view('tenants.reports')/tenants/tenant/report[@tenant=$tenant][@report=$report]/@topology3"/>

      



        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>

        <!--<connector type="StringConnector">-->
            <!--<parameter name="content" eval="$url"></parameter>-->
        <!--</connector>-->
        <!--<serializer type="EncapsulateSerializer"/>-->
    <processors>

        <element in="root">
            <attribute-create out="details">3</attribute-create>
            <attribute-create out="tenant">$tenant</attribute-create>
            <attribute-create out="report">$report</attribute-create>
            <attribute-create out="ApiUrl">$url</attribute-create>
            <attribute-create out="group">$group</attribute-create>
           
            <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>

        </element>

        <element in="root">


            <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
            <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>
            <attribute-create out="month">$month</attribute-create>
            <attribute-create out="topology">$topology</attribute-create>
            <attribute-create out="topology2">$topology2</attribute-create>
            <attribute-create out="topology3">$topology3</attribute-create>
            <attribute-create out="group2" if="$group2!='_group2_'">$group2</attribute-create>
            <attribute-create out="group3" if="$group3!='_group3_'">$group3</attribute-create>
            <attribute-create out="start_time">$start_time</attribute-create>
            <attribute-create out="end_time">$end_time</attribute-create>
            <attribute-create out="start_date">substring($start_time,0,11)</attribute-create>
            <attribute-create out="end_date">substring($end_time,0,11)</attribute-create>
        </element>

        <element in="root" >
            <element-ignore in="group">
                <element-ignore in="group">
                    <element/>
                </element-ignore>
            </element-ignore>
        </element>



        <element in="root">
            <element in="group">
                <element in="results">
                    <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                </element>
            </element>
        </element>



    </processors>



    <renderers>
        <renderer type="HTMLRenderer">
            <parameter name="template">app/html/report_daily.html</parameter>
        </renderer>
        <renderer type="DefaultRenderer">
            <parameter name="contentType">text/xml</parameter>
        </renderer>
    </renderers>

</view>

    <view name="report-ar-group"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>
        <argument name="topology">NGI</argument>
        <argument name="entity">_entity_</argument>
        <argument name="month">2018-06</argument>
        <argument name="group">NGI_FRANCE</argument>
        <argument name="details">_details_</argument>


        <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>

        <variable name="start_time" eval="concat($month,'-01T00:00:00Z')"/>
        <variable name="end_time" eval="concat(str:replace(substring(date:add($start_time,concat('P',1,'M')),0,20),' ','T'),'Z')"/>

        <variable name="url"  eval="choose($details='_details_',
        concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=daily'),
        concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'/services/',$details,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=daily'))"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>

        <processors>

            <element in="root">
                <element-ignore in="group" if="@type!=$topology"><element/></element-ignore>
            </element>


            <element in="root">               
                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>
                <element-ignore in="group" if="group">
                    <element-ignore in="group" if="@name!=$group and ancestor::group/@name!=$group"/>
                    <element/>
                </element-ignore>
            </element>



            <element in="root" >
                <attribute-create out="ApiUrl">$url</attribute-create>
                <attribute-create out="topology">$topology</attribute-create>
                <attribute-create out="group">$group</attribute-create>
                <attribute-create out="month">$month</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="start_date">substring($start_time,0,11)</attribute-create>
                <attribute-create out="end_date">substring($end_time,0,11)</attribute-create>

            </element>



            <element in="root">


                <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
                <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>

                <element in="group">
                    <element in="results">
                        <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                    </element>
                </element>
            </element>

        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report_daily.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="report-ar-group-details"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">


        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="topology"/>
        <argument name="nbmonths">5</argument>
        <argument name="group"/>
        <argument name="topology3">_topo3_</argument>




        <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>

        <variable name="start_time" eval="concat(str:replace(substring(date:add(date:date-time(),concat('-P',$nbmonths,'M')),0,20),' ','T'),'Z')"/>
        <variable name="end_time" eval="concat(str:replace(substring(date:date-time(),0,20),' ','T'),'Z')"/>

        <variable name="topology2" eval="view('tenants.reports')/tenants/tenant/report[@tenant=$tenant][@report=$report]/@topology3"/>

        <variable name="url"  eval="
        choose($topology3!='_topo3_',
        concat(property('api.report'),'/',$report,'/',$topology2,'/',$group,'/',$topology3,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=monthly'),
        concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'/',$topology2,'?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=monthly')
                )"/>

        <variable name="month_1" eval="substring($start_time,0,8)"/>
        <variable name="month_2" eval="substring(date:add(date:date-time(),concat('-P',3,'M')),0,8)"/>
        <variable name="month_3" eval="substring(date:add(date:date-time(),concat('-P',2,'M')),0,8)"/>
        <variable name="month_4" eval="substring(date:add(date:date-time(),concat('-P',1,'M')),0,8)"/>
        <variable name="month_5" eval="substring(date:date-time(),0,8)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>

        <processors>

            <element in="root">
                <attribute-create out="details" if="topology3='_topo3_'">1</attribute-create>
                <attribute-create out="details" if="topology3!='_topo3_'">2</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="ApiUrl">$url</attribute-create>

                <attribute-create out="group">$group</attribute-create>
               <attribute-create out="start_date">substring($start_time,0,11)</attribute-create>
                <attribute-create out="end_date">substring($end_time,0,11)</attribute-create>
                <attribute-create out="month1">choose(../group[count(results)=$nbmonths+1]/results[1]/@timestamp,../group[count(results)=$nbmonths+1]/results[1]/@timestamp,$month_1)</attribute-create>
                <attribute-create out="month2">choose(../group[count(results)=$nbmonths+1]/results[2]/@timestamp,../group[count(results)=$nbmonths+1]/results[2]/@timestamp,$month_2)</attribute-create>
                <attribute-create out="month3">choose(../group[count(results)=$nbmonths+1]/results[3]/@timestamp,../group[count(results)=$nbmonths+1]/results[3]/@timestamp,$month_3)</attribute-create>
                <attribute-create out="month4">choose(../group[count(results)=$nbmonths+1]/results[4]/@timestamp,../group[count(results)=$nbmonths+1]/results[4]/@timestamp,$month_4)</attribute-create>
                <attribute-create out="month5">choose(../group[count(results)=$nbmonths+1]/results[5]/@timestamp,../group[count(results)=$nbmonths+1]/results[5]/@timestamp,$month_5)</attribute-create>

                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>



            </element>

            <element in="root">


                <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
                <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>
                <attribute-create out="topology">$topology</attribute-create>
                <attribute-create out="topology2">$topology2</attribute-create>
                <attribute-create out="topology3">$topology3</attribute-create>


            </element>

            <element in="root" >
                <element-ignore in="group" if="group">
                    <element-ignore in="group" if="@name!=$group and ancestor::group/@name!=$group"/>
                    <element/>
                </element-ignore>
            </element>




            <element in="root">

                <element in="group">
                    <element in="results">
                        <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                    </element>
                </element>
            </element>

        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="report-ar-endpoint-details"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">


        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="topology"/>
        <argument name="nbmonths">5</argument>
        <argument name="group"/>
        <argument name="topology2"/>
        <argument name="group2"/>


        <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>

        <variable name="start_time" eval="concat(str:replace(substring(date:add(date:date-time(),concat('-P',$nbmonths,'M')),0,20),' ','T'),'Z')"/>
        <variable name="end_time" eval="concat(str:replace(substring(date:date-time(),0,20),' ','T'),'Z')"/>

        <variable name="topology3" eval="view('tenants.reports')/tenants/tenant/report[@tenant=$tenant][@report=$report]/@topology3"/>

        <variable name="url"  eval="concat(property('api.report'),'/',$report,'/',$topology,'/',$group,'/',$topology2,'/',$group2,'/endpoints?start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;granularity=monthly') "/>

        <variable name="month_1" eval="substring($start_time,0,8)"/>
        <variable name="month_2" eval="substring(date:add(date:date-time(),concat('-P',3,'M')),0,8)"/>
        <variable name="month_3" eval="substring(date:add(date:date-time(),concat('-P',2,'M')),0,8)"/>
        <variable name="month_4" eval="substring(date:add(date:date-time(),concat('-P',1,'M')),0,8)"/>
        <variable name="month_5" eval="substring(date:date-time(),0,8)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>



        <processors>

            <element in="root">
                <attribute-create out="details" if="topology3='_topo3_'">1</attribute-create>
                <attribute-create out="details" if="topology3!='_topo3_'">2</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="ApiUrl">$url</attribute-create>
                <attribute-create out="group">$group</attribute-create>
               <attribute-create out="start_date">substring($start_time,0,11)</attribute-create>
                <attribute-create out="end_date">substring($end_time,0,11)</attribute-create>
                <attribute-create out="month1">choose(../group[count(results)=$nbmonths+1]/results[1]/@timestamp,../group[count(results)=$nbmonths+1]/results[1]/@timestamp,$month_1)</attribute-create>
                <attribute-create out="month2">choose(../group[count(results)=$nbmonths+1]/results[2]/@timestamp,../group[count(results)=$nbmonths+1]/results[2]/@timestamp,$month_2)</attribute-create>
                <attribute-create out="month3">choose(../group[count(results)=$nbmonths+1]/results[3]/@timestamp,../group[count(results)=$nbmonths+1]/results[3]/@timestamp,$month_3)</attribute-create>
                <attribute-create out="month4">choose(../group[count(results)=$nbmonths+1]/results[4]/@timestamp,../group[count(results)=$nbmonths+1]/results[4]/@timestamp,$month_4)</attribute-create>
                <attribute-create out="month5">choose(../group[count(results)=$nbmonths+1]/results[5]/@timestamp,../group[count(results)=$nbmonths+1]/results[5]/@timestamp,$month_5)</attribute-create>

                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>



            </element>

            <element in="root">


                <attribute-create out="level1">../report[@tenant=../@tenant][@report=../@report]/@thresholdAv</attribute-create>
                <attribute-create out="level2">../report[@tenant=../@tenant][@report=../@report]/@thresholdRe</attribute-create>
                <attribute-create out="topology">$topology</attribute-create>
                <attribute-create out="topology2">$topology2</attribute-create>


                <attribute-create out="group">$group</attribute-create>
                <attribute-create out="group2">$group2</attribute-create>
                
            </element>

            <element in="root" >
                <element-ignore in="group" >
                    <element-ignore in="group" >
                        <element/>
                    </element-ignore>
                </element-ignore>
            </element>




            <element in="root">

                <element in="group">
                    <element in="results">
                        <attribute if="name()!='timestamp'">round(. * 100 ) div 100</attribute>
                    </element>
                </element>
            </element>

        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="report-ar"  xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="topology"/>
        <argument name="entity">_entity_</argument>
        <argument name="group">_group_</argument>
        <argument name="nbdays">30</argument>

        <variable name="api-key" eval="property(concat($tenant,'.api.key'))"/>
        <variable name="start_time" eval="concat(str:replace(substring(date:add(date:date-time(),concat('-P',$nbdays,'D')),0,20),' ','T'),'Z')"/>
        <variable name="end_time" eval="concat(str:replace(substring(date:date-time(),0,20),' ','T'),'Z')"/>

        <variable name="url" eval="choose($entity='_entity_',concat(property('api.report'),'/',$report,'/',$topology,'?start_time=',$start_time,'&amp;end_time=',$end_time),concat(property('api.report'),'/',$report,'/',$topology,'/',$entity,'?start_time=',$start_time,'&amp;end_time=',$end_time))"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
        </connector>


        <processors>



            <element out="root">

                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="url">$url</attribute-create>
                <element-create>view('tenants.reports')/tenants/tenant[id/text()=$tenant]/report</element-create>

                <element-ignore in="group">
                    <element in="results">
                        <attribute-create out="id">../../@name</attribute-create>
                    </element>
                    <element-ignore in="group">
                        <element in="results">
                            <attribute-create out="id">../../@name</attribute-create>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>



            <element in="root">
                <element-ignore in="results"/>
                <element-create>sort_by_string(../results,'@timestamp')</element-create>
            </element>


            <element in="root">
                <element-create-as-parent out="group" group-by="@timestamp" attributes="@timestamp">
                    <element in="results"/>
                </element-create-as-parent>
            </element>

            <element in="root">
                <element in="group">
                    <attribute-create out="availability">sum(../results/@availability) div (count(../results/@availability))</attribute-create>
                    <attribute-create out="reliability">sum(../results/@reliability) div (count(../results/@reliability))</attribute-create>
                </element>
            </element>


            <element in="root">
                <attribute-create out="availability">sum(../group/@availability) div (count(../group/@availability))</attribute-create>
                <attribute-create out="reliability">sum(../group/@reliability) div (count(../group/@reliability))</attribute-create>
            </element>

            <element in="root" out="report-ar">

                <attribute in="availability">round(.*100) div 100 </attribute>
                <attribute in="reliability">round(.*100) div 100 </attribute>

                <element in="group">
                    <attribute in="availability">round(.*100) div 100 </attribute>
                    <attribute in="reliability">round(.*100) div 100 </attribute>
                    <element-ignore/>
                </element>
            </element>



        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/report.html</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



</views>