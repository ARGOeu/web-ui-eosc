<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : argo-eosc 
        File    : trends.xml
        Created by cyril on 2021/06/04 
    -->

    <view name="api.status.date" authenticators="admin">

    <argument name="date"/>
    <argument name="report"/>
    <argument name="tenant"/>
    <argument name="top"/>
        <argument name="type">metrics</argument>
    <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>
    <variable name="url" eval="property('api.trends')"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="choose($top='all',concat($url,$report,'/status/',$type,'?date=',$date),concat($url,$report,'/status/metrics','?date=','&amp;top=',$top))"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
            <fallback
                    eval="new_element('exception',new_attribute('exception',' : exception with api.flapping.status view '))">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>

        <serializer type="JSONStreamSerializer"/>

    </view>

    <view name="api.status.range" authenticators="admin">
        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="start_date"/>
        <argument name="end_date"/>
        <argument name="top"/>
        <argument name="granularity">_granularity_</argument>
        <argument name="type">metrics</argument>


        <variable name="option" eval="choose($granularity!='_granularity_',concat('?granularity=',$granularity,'&amp;'),'?')"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>

        <variable name="base-url" eval="property('api.trends')"/>
        <variable name="url" eval="choose($top='all',concat($base-url,$report,'/status/',$type,$option,'start_date=',$start_date,'&amp;end_date=',$end_date),concat($base-url,$report,'/status/',$type,$option,'start_date=',$start_date,'&amp;end_date=',$end_date,'&amp;top=',$top))"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
            <fallback
                    eval="new_element('exception',new_attribute('exception',' : exception with api.status.range view '))">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>

        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object">
                <attribute-create out="url">$url</attribute-create>
            </element>
        </processors>

    </view>

    <view name="api.tags.date" authenticators="admin">

        <argument name="date"/>
        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="top"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>
        <variable name="url" eval="property('api.trends')"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="choose($top='all',concat($url,$report,'/status/metrics/tags','?date=',$date),concat($url,$report,'/status/metrics/tags','?date=','&amp;top=',$top))"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
            <fallback
                    eval="new_element('exception',new_attribute('exception',' : exception with api.tags.status view '))">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>

        <serializer type="JSONStreamSerializer"/>

    </view>

    <view name="api.tags.range" authenticators="admin">
        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="start_date"/>
        <argument name="end_date"/>
        <argument name="top"/>
        <argument name="granularity">_granularity_</argument>

        <variable name="option" eval="choose($granularity!='_granularity_',concat('?granularity=',$granularity,'&amp;'),'?')"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>

        <variable name="base-url" eval="property('api.trends')"/>
        <variable name="url" eval="choose($top='all',concat($base-url,$report,'/status/metrics/tags',$option,'start_date=',$start_date,'&amp;end_date=',$end_date),concat($base-url,$report,'/status/metrics/tags',$option,'start_date=',$start_date,'&amp;end_date=',$end_date,'&amp;top=',$top))"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
            <fallback
                    eval="new_element('exception',new_attribute('exception',' : exception with api.tags.range view '))">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>


        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object">
                <attribute-create out="url">$url</attribute-create>
            </element>
        </processors>

    </view>

    <view name="api.flapping.date" authenticators="admin">

        <argument name="type"/>
        <argument name="date"/>
        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="top"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>


    <variable name="url" eval="property('api.trends')"/>

    <connector type="HTTPConnector">
        <parameter name="url" eval="choose($top='all',concat($url,$report,'/flapping/',$type,'?date=',$date),concat($url,$report,'/flapping/',$type,'?date=',$date,'&amp;top=',$top))"/>
        <parameter name="force-redirect">true</parameter>
        <parameter name="header">
            <entry key="x-api-key" eval="$api-key"/>
            <entry key="Accept">application/json</entry>
        </parameter>
        <fallback
                eval="new_element('exception',new_attribute('exception',' : exception with api.flapping.date view '))">
            <exception type="java.io.IOException"/>
        </fallback>
    </connector>
    <serializer type="JSONStreamSerializer"/>
    </view>

    <view name="api.flapping.range" authenticators="admin">

        <argument name="type"/>
        <argument name="report"/>
        <argument name="tenant"/>
        <argument name="start_date"/>
        <argument name="end_date"/>
        <argument name="top"/>
        <argument name="granularity"/>


        <variable name="option" eval="choose($granularity!='_granularity_',concat('?granularity=',$granularity,'&amp;'),'?')"/>
        <variable name="api-key" eval="view('tenants')/tenants/tenant[name/text()=upper-case($tenant)]/api_key/text()"/>
        <variable name="base-url" eval="property('api.trends')"/>
        <variable name="url" eval="choose($top='all',concat($base-url,$report,'/flapping/',$type,$option,'start_date=',$start_date,'&amp;end_date=',$end_date),concat($base-url,$report,'/flapping/',$type,$option,'start_date=',$start_date,'&amp;end_date=',$end_date,'&amp;top=',$top))"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="$api-key"/>
                <entry key="Accept">application/json</entry>
            </parameter>
            <fallback
                    eval="new_element('exception',new_attribute('exception',' : exception api.flapping.range flapping view '))">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>
        <serializer type="JSONStreamSerializer"/>
        <processors>
            <element in="object">
                <attribute-create out="url">$url</attribute-create>
            </element>
        </processors>
    </view>

    <view name="trends-status-eudat" authenticators="eudat">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('trends-status',arguments())"/>
        </connector>
        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/trends/trends.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="trends-tags-eudat" authenticators="eudat">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('trends-tags',arguments())"/>
        </connector>
        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/trends/trends.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="trends-tags" xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">
        <argument name="date" eval="substring(date:date-time(),0,11)"/>
        <argument name="start_date">_start_date_</argument>
        <argument name="end_date">_end_date_</argument>
        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>
        <argument name="top">all</argument>
        <argument name="granularity">_granularity_</argument>
        <argument name="trends">tags</argument>
        <argument name="tag">_tag_</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>

        <element in="root">
            <attribute-create out="date">$date</attribute-create>
            <attribute-create out="start_date">$start_date</attribute-create>
            <attribute-create out="end_date">$end_date</attribute-create>
            <attribute-create out="tenant">$tenant</attribute-create>
            <attribute-create out="report">$report</attribute-create>
            <attribute-create out="top">$top</attribute-create>
            <attribute-create out="granularity">$granularity</attribute-create>
            <attribute-create out="trends">$trends</attribute-create>
            <attribute-create out="tag">$tag</attribute-create>
            <attribute-create out="topology2">view('tenants.reports')/tenants/tenant[@id=$tenant]/report[@name=$report]/@topology2</attribute-create>
            <attribute-create out="topology3">view('tenants.reports')/tenants/tenant[@id=$tenant]/report[@name=$report]/@topology3</attribute-create>
            <element-create>view('tenants.reports')/tenants/tenant/report</element-create>
            <element-create>new_element("tags")</element-create>
        </element>

            <element in="root">
                <element if="name()='tags'">
                    <element-create if="$start_date='_start_date_'">view('api.tags.date',entry('date',$date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('granularity',$granularity))</element-create>
                    <element-create if="$start_date!='_start_date_'">view('api.tags.range',entry('start_date',$start_date)|entry('end_date',$end_date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('granularity',$granularity))</element-create>
                </element>
            </element>

            <element in="root">
                <element in="tags">
                    <elements-ignore path="object/data">
                        <element/>
                    </elements-ignore>
                </element>
            </element>

            <element in="root">
                <element in="tags">
                    <elements path="object/top">
                        <element in="object">
                            <attribute-create out="link">concat('/',/root/@tenant,'/report-status/',/root/@report,'/',/root/@topology2,'/',../endpoint_group/text(),'/',../service/text(),'/',../endpoint/text())</attribute-create>
                        </element>
                    </elements>
                </element>
            </element>

        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/trends/trends.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="trends-status" xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

    <argument name="date" eval="substring(date:date-time(),0,11)"/>
    <argument name="start_date">_start_date_</argument>
    <argument name="end_date">_end_date_</argument>
    <argument name="report">Critical</argument>
    <argument name="tenant">egi</argument>
    <argument name="top">all</argument>
    <argument name="granularity">_granularity_</argument>
    <argument name="trends">status</argument>
        <argument name="type">_type_</argument>

    <connector type="XMLConnector">
        <parameter name="content" eval="new_element('root')"/>
    </connector>

    <processors>

        <element in="root">
            <attribute-create out="date">$date</attribute-create>
            <attribute-create out="start_date">$start_date</attribute-create>
            <attribute-create out="end_date">$end_date</attribute-create>
            <attribute-create out="tenant">$tenant</attribute-create>
            <attribute-create out="report">$report</attribute-create>
            <attribute-create out="top">$top</attribute-create>
            <attribute-create out="granularity">$granularity</attribute-create>
            <attribute-create out="trends">$trends</attribute-create>
            <attribute-create out="type">$type</attribute-create>
            <attribute-create out="topology2">view('tenants.reports')/tenants/tenant[@id=$tenant]/report[@name=$report]/@topology2</attribute-create>
            <attribute-create out="topology3">view('tenants.reports')/tenants/tenant[@id=$tenant]/report[@name=$report]/@topology3</attribute-create>
            <element-create>view('tenants.reports')/tenants/tenant/report</element-create>
            <element-create if="$trends='status'">new_element("status")</element-create>
        </element>


        <element in="root">
            <element if="name()='status' and $type!='_type_'">
                <element-create if="$start_date='_start_date_'">view('api.status.date',entry('date',$date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('granularity',$granularity)|entry('type',$type))</element-create>
                <element-create if="$start_date!='_start_date_'">view('api.status.range',entry('start_date',$start_date)|entry('end_date',$end_date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('type',$type)|entry('granularity',$granularity))</element-create>
            </element>
        </element>


        <element in="root">
            <element in="status">
                <attribute-create out="url">../object/@url</attribute-create>
                <elements-ignore path="object/data">
                    <element/>
                </elements-ignore>
            </element>
        </element>

        <element in="root">
            <element in="status">
                <elements path="object/top">
                    <element in="object">
                        <attribute-create out="link">concat('/',/root/@tenant,'/report-status/',/root/@report,'/',/root/@topology2,'/',../endpoint_group/text(),'/',../service/text(),'/',../endpoint/text())</attribute-create>
                    </element>
                </elements>
            </element>
        </element>

    </processors>



    <renderers>
        <renderer type="HTMLRenderer">
            <parameter name="template">app/html/trends/trends.html</parameter>
        </renderer>
    </renderers>
    </view>


    <view name="trends-flapping-eudat" authenticators="eudat">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('trends-flapping',arguments())"/>
        </connector>
        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/trends/trends.html</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="trends-flapping" xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings">

        <argument name="date" eval="substring(date:date-time(),0,11)"/>
        <argument name="start_date">_start_date_</argument>
        <argument name="end_date">_end_date_</argument>
        <argument name="report">Critical</argument>
        <argument name="tenant">egi</argument>
        <argument name="top">all</argument>
        <argument name="granularity">_granularity_</argument>
        <argument name="trends">flapping</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>

            <element in="root">
                <attribute-create out="date">$date</attribute-create>
                <attribute-create out="start_date">$start_date</attribute-create>
                <attribute-create out="end_date">$end_date</attribute-create>
                <attribute-create out="tenant">$tenant</attribute-create>
                <attribute-create out="report">$report</attribute-create>
                <attribute-create out="top">$top</attribute-create>
                <attribute-create out="granularity">$granularity</attribute-create>
                <attribute-create out="trends">$trends</attribute-create>



                <element-create>view('tenants.reports')/tenants/tenant/report</element-create>

                <element-create>new_element("groups")</element-create>
                <element-create >new_element("services")</element-create>
                <element-create >new_element("endpoints")</element-create>
                <element-create >new_element("metrics")</element-create>

                <element-create>new_element("dates")</element-create>


            </element>

            <element in="root">
                <element if="name()!='report' and name()!='dates'">
                    <element-create if="$start_date='_start_date_'">view('api.flapping.date',entry('type',name(..))|entry('date',$date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('granularity',$granularity))</element-create>
                    <element-create if="$start_date!='_start_date_'">view('api.flapping.range',entry('type',name(..))|entry('start_date',$start_date)|entry('end_date',$end_date)|entry('report',$report)|entry('tenant',$tenant)|entry('top',$top)|entry('granularity',$granularity))</element-create>
                </element>
            </element>


            <element in="root" if="$granularity='_granularity_'">
                <element if="name()!='status'">
                    <attribute-create out="url">../object/@url</attribute-create>
                    <elements-ignore path="object/data">
                        <element-ignore in="object"/>
                        <element-create>sort_by_string(../object,'endpoint_group/text()')</element-create>
                    </elements-ignore>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element if="name()!='status'">
                    <elements path="object/data/object/date">
                        <text>concat(.,',')</text>
                    </elements>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element in="dates">
                    <element-create>str:concat(../../*/object/data/object/date/text())</element-create>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element if="name()!='status'">
                    <attribute-create out="url" if="../object/@url">../object/@url</attribute-create>
                    <elements-ignore path="object/data/object/top">
                                <element in="object">
                                    <attribute-create out="key">concat(../endpoint_group,'**',../service,'**',../endpoint,'**',../metric)</attribute-create>
                                    <element in="flapping">
                                        <attribute-create out="date">substring-before(ancestor::object/date/text(),',')</attribute-create>
                                    </element>
                                </element>
                    </elements-ignore>
                </element>

            </element>

            <element in="root" if="$granularity!='_granularity_'">
                    <element if="name()!='status'">
                        <element-ignore in="object"/>
                        <element-create>sort_by_string(../object,'@key')</element-create>
                    </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element if="name()!='status'">
                   <element-create-as-parent out="object" group-by="@key">
                       <element-ignore in="object"><element></element></element-ignore>
                   </element-create-as-parent>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element>
                    <element in="object">
                        <element in="endpoint_group" if="not(preceding-sibling::endpoint_group)"></element>
                        <element in="service" if="not(preceding-sibling::service)"></element>
                        <element in="endpoint" if="not(preceding-sibling::endpoint)"></element>
                        <element in="metric" if="not(preceding-sibling::metric)"></element>
                        <element in="flapping"/>
                        <element-ignore/>
                    </element>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element in="dates">
                    <element-create>str:split(../text(),',')</element-create>
                    <text-ignore/>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element in="dates">
                    <element in="token" out="date" if="not(preceding-sibling::token/text()=current()/text())"/>
                    <element-ignore/>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_'">
                <element if="name()!='dates'">
                    <element in="object">
                        <element-create>../../../dates</element-create>
                    </element>
                </element>
            </element>

            <element in="root" if="$granularity!='_granularity_' and $trends!='status'">
                <element if="name()!='dates'">
                    <element in="object">
                        <element in="dates" out="flappings">
                            <element in="date" out="flapping">
                                <attribute-create out="date">../text()</attribute-create>
                                <text-ignore/>
                                <text-create if="../../../flapping[@date=current()/../text()]/text()">../../../flapping[@date=current()/../text()]/text()</text-create>
                                <text-create if="not(../../../flapping[@date=current()/../text()]/text())">0</text-create>
                            </element>
                        </element>
                        <element-ignore in="flapping"/>
                    </element>
                </element>
                <element-ignore/>
            </element>



        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/trends/trends.html</parameter>
            </renderer>
        </renderers>


    </view>

</views>