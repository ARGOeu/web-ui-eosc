<!DOCTYPE html>
<html lang="en" xmlns:tpl="http://software.in2p3.fr/lavoisier/template.xsd" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times">

<head tpl:include="/resource/app/html/header.html"></head>

<body class="sidebar-mini layout-fixed layout-navbar-fixed" style="height: auto;" cz-shortcut-listen="true">
<div class="wrapper">
    <!-- Navbar -->
    <nav tpl:include="/resource/app/html/navbar.html"></nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside tpl:include="/resource/app/html/sidebar.html"></aside>
    <!-- /sidebar -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-9">

                    </div><!-- /.col -->
                    <div class="col-sm-3">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active"> Recomputation Form</li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <div class="content">
            <div class="container-fluid">
                <div class="row" tpl:foreach="/root[not(result)]">
                    <div class="col-lg-12">

                        <div class="card border border-primary">
                            <div class="card-header ui-sortable-handle" style="cursor: move;">
                                <h3 class="card-title" tpl:if="not(/root/@update)">
                                    <i class="ion ion-clipboard mr-1"></i>
                                    Recomputation
                                </h3>
                                <h3 class="card-title" tpl:else="">
                                    <i class="ion ion-clipboard mr-1"></i>
                                    Update Recomputation #{{/root/@update}}
                                </h3>



                            </div>
                            <!-- /.card-header -->
                            <div class="card-body" tpl:if="not(/root/@update)">
                                <div class="row label label-info m-2">
                                    <div class="col-1">
                                        <br/>
                                        <span class="fa fa-4x fa-exclamation-triangle m-2">  </span>
                                        <br/>
                                    </div>

                                    <div class="col-10" >
                                    <ul> A recomputation is done in several steps
                                        <li>We study the request if the reason is valid we proceed to the recomputation</li>
                                        <li>First we will exclude services/metrics results (unknown status) concerned by the issue from reports  </li>
                                        <li>Then we will re-compute figures for the site(s)</li>
                                        <li>In any case we will recompute results at the  services or metrics level</li>

                                    </ul>
                                    </div>

                                </div>

                            </div>
                            <div class="card-body" >
                            <form action="/form_recomputation_results" method="post" class="needs-validation" novalidate="true">

                                <input tpl:if="/root/@update" class="d-none" name="update"  value="{/root/@update}"/>

                            <div class="row">
                                <div class="col-6">
                                    <label for="name">name</label>
                                    <input name="name" tpl:if="not(/root/@update)" class="form-control"  id="name" value="{{/root/object/name/text()}}" required="true"/>
                                    <input name="name" tpl:else="" class="form-control"  id="name" value="{{/root/root/data/requester_name/text()}}" required="true"/>
                                    <div class="invalid-feedback">
                                        Please provide your name
                                    </div>
                                    <hr/>
                                </div>
                                <div class="col-6">
                                    <label for="email">email</label>
                                    <input name="email" tpl:if="not(/root/@update)" class="form-control"  id="email" value="{{/root/object/email/text()}}" required="true"/>
                                    <input name="email" tpl:else="" class="form-control"  id="email" value="{{/root/root/data/requester_email/text()}}" required="true"/>
                                    <div class="invalid-feedback">
                                        Please provide your email
                                    </div>
                                    <hr/>
                                </div>


                                <input name="tenant" class="d-none"  value="{{/root/@tenant}}"/>
                                <input name="baseUrl" id="baseUrl" class="d-none"/>




                            </div>

                                <div class="row">



                                    <div class="col-6">
                                        <label>Report</label>
                                        <div id="report"  style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">

                                            <input name="report" style="border:0"  readonly="true" value="{{/root/@report}}"/>

                                        </div>
                                        <hr/>


                                    </div>




                                    <div   class="col-6">
                                        <label>Period</label>
                                        <div id="reportrange"  style="background: #fff; cursor: pointer; padding: 5px 6px; border: 1px solid #ccc; width: 100%">
                                            <i class="fa fa-calendar m-1"></i>
                                            <input id="period" name="period" style="border:0" required="true" class="col-7"></input> <i class="m-1 fa fa-caret-down"></i>
                                            <div class="invalid-feedback">
                                                Please provide the period on which you want to apply recomputation
                                            </div>

                                        </div>
                                        <hr/>

                                        <input tpl:if="not(/root/@update)" class="d-none" name="start_time" id="start_time" value="0"/>
                                        <input tpl:else="" class="d-none" name="start_time" id="start_time" value="{{/root/root/data/start_time}}"/>

                                        <input tpl:if="not(/root/@update)" class="d-none" name="end_time" id="end_time" value="0"/>
                                        <input tpl:else="" class="d-none" name="end_time" id="end_time" value="{{/root/root/data/end_time}}"/>
                                    </div>


                                    </div>

                                <div class="row form-group">

                                    <div class="col-4">
                                        <label>Sites to be excluded</label>
                                        <select tpl:if="not(/root/@update)" id="services"   multiple="true" class="form-control" required="true">
                                            <option  tpl:foreach="report[@tenant=/root/@tenant][@report=/root/@report]/endpoint_group_list/item/text()"
                                                     value="{.}">{{.}}
                                            </option>

                                        </select>

                                        <select tpl:else="" id="services"   multiple="true" class="form-control" required="true">
                                            <option tpl:foreach="/root/root/data/exclude/item" value="{.}" selected="true">{{.}}</option>
                                            <option  tpl:foreach="report[@tenant=/root/@tenant][@report=/root/@report]/endpoint_group_list/item/text()"
                                                     value="{.}">{{.}}
                                            </option>

                                        </select>

                                        <div class="invalid-feedback">
                                            Please select the site or the service group which you should be excluded during the recomputation
                                        </div>
                                        <input class="d-none" id="entity" name="entity"/>
                                        <hr/>
                                    </div>
                                    <div class="col-8">
                                        <label for="reason">Reason of recomputation</label>
                                        <textarea tpl:if="not(/root/@update)" name="reason" class="form-control" id="reason" rows="4" required="true"></textarea>
                                        <textarea tpl:else="" name="reason" class="form-control" id="reason" rows="4" required="true">{{/root/root/data/reason}}</textarea>

                                        <div class="invalid-feedback">
                                            Please provide a valid reason to trigger a recomputation
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12 float-right">
                                        <input value="Submit Recomputation" type="submit"   class="btn btn-primary"/>
                                    </div>

                                </div>
                            </form>
                            </div>



                            <!-- /.card-body -->

                        </div>

                        <!-- /.card -->


                        <!-- /.card -->
                    </div>

                </div>
                <div class="row" tpl:foreach="/root[result]">
                    <div class="col-lg-12">

                        <div class="card border border-primary">
                            <div class="card-header ui-sortable-handle" style="cursor: move;">
                                <h3 class="card-title">
                                    Recomputation summary
                                </h3>
                                <div class="card-body" tpl:if="/root/result/e:entries/e:entry[@key='update']">
                                    <div class="alert alert-success">Your recomputation has been properly updated.</div>
                                </div>
                                <div class="card-body" tpl:else="">
                                    <div class="alert alert-success">Your recomputation has been properly submitted . <br/>You will receive an email soon with a link to follow the recomputation progress</div>
                                </div>

                                <div class="card-body" >
                                    <div class="row">
                                        <div tpl:foreach="result/e:entries/e:entry[@key!='baseUrl']" class="col-4">
                                            <hr/>
                                            <label>{{@key}} </label>
                                            <div>{{text()}}</div>
                                        </div>


                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <!-- Main Footer -->

    <footer tpl:include="/resource/app/html/footer.html"></footer>

</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="/resource/app/html/adminlte/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="/resource/app/html/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- adminlte -->
<script src="/resource/app/html/adminlte/dist/js/adminlte.js"></script>


<!-- date range picker -->

<link rel="stylesheet" href="/resource/app/html/adminlte/plugins/daterangepicker/daterangepicker.css"/>
<script src="/resource/app/html/adminlte/plugins/daterangepicker/moment.min.js"></script>
<script src="/resource/app/html/adminlte/plugins/daterangepicker/daterangepicker.min.js"></script>
<script src="/resource/app/js/recomputation.js?v={$app.version}"></script>

>
</body>
</html>

